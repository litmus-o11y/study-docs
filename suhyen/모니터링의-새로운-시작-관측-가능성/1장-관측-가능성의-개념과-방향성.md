# 1. 관측 가능성

### 관측 가능성이란 무엇인가?

관측 가능성의 정의는 다음과 같다.

> 시스템에서 외부로 출력되는 값만을 사용해서, 시스템의 내부 상태를 이해하고 예측하는 것

관측 가능성과 같이 언급되는 단어로는 모니터링이 있다. 하지만 관측 가능성이 모니터링을 대체하는 개념은 아니다. 모니터링은 블랙박스와 화이트박스 영역을 포함하지만, 관측 가능성은 화이트박스와 예측 영역을 포함한다.

<img width="336" alt="스크린샷 2024-09-08 오전 12 07 32" src="https://github.com/user-attachments/assets/8824123c-763b-4e2c-ab5f-64ff852a6982">

또한 전통적인 모니터링은 블랙박스 모니터링을 기본으로 하며, 핵심적인 애플리케이션과 시스템 메트릭에 집중한다. 반면 관측 가능성은 클라우드 네이티브처럼 분산되고 복잡한 시스템에서 발생하는 이벤트에 대한 통찰력 제공을 목표로 한다.  
이러한 관측 가능성 분야는 빠르게 변화하고 새로운 기술이 속속 등장하고 있기 때문에 특정 기술을 고집하는 것 보다는 쉽게 개선 가능하고 유연한 아키텍처를 설계하는 것이 중요하다.

<details>
<summary>관측 가능성 vs 가시성</summary>

해당 책에서, 관측 가능성은 애플리케이션 레벨에서 발생하는 것을 범주로 두고 있고, 가시성은 인프라와 네트워크 레벨에서 발생하는 것을 범주로 두고 있다. 

<img width="342" alt="스크린샷 2024-09-14 오후 5 46 00" src="https://github.com/user-attachments/assets/47cea8b3-cf10-49f6-ad83-8d055a0b81d1">

</details>

# 2. 메트릭

### SLI와 SLO는 무엇인가?

- SLI = Service Level Indicator = 서비스 수준 지표
- SLO = Service Level Objective = 서비스 수준 목표

SLI는 SLO를 달성해야 하며, SLO는 SLI의 상한과 하한 범위를 지정한다. 주요 SLO 지표로는 가용성, 지연, 에러가 있으며, 이때 **메트릭은 가용성을 측정하는 주요 관찰 수단**이다.

<details>
<summary>지연 vs 에러</summary>

빈번하게 발생하는 지연(latency)은 에러가 아닌 경우가 많기 때문에 지연과 에러는 구분되어야 한다. 하지만 에러라고 판단할 수 있는 기준이 불분명한 경우도 많기 때문에 에러의 기준을 명확히 설정해야 한다.
예를 들어, HTTP 500과 잘못된 내용을 가진 HTTP 200 응답이 있다고 가정해보자. HTTP 200은 일반적으로는 정상 응답이지만, 소스 버그 혹은 인프라 문제 등으로 인해서 에러가 발생할 수도 있기 때문에 잘못된 내용은 테스트하고 분석해서 에러를 결정해야 한다.

</details>

### 메트릭이란 무엇인가?

**메트릭**(**metric**)은 일정 시간 동안 측정된 데이터를 집계하고 이를 수치화한다. 예를 들어 큐의 대기(pending) 메시지 개수, 사용 중인 CPU와 메모리의 크기, 서비스에서 초당 처리하는 개수 등이 있다.  
일반적으로 메트릭에는 카운터, 게이지, 요약, 히스토그램의 네 가지 유형이 있다.

- 카운터(counter): 모니터링하는 이벤트의 누적 개수 혹은 크기를 표현하며, 일반적으로 rate 함수와 같이 사용하는 경우가 많다.
- 게이지(gauge): 카운터와 달리 증가하거나 감소하는 임의의 값을 나타내며, ‘현재 상태’를 표현한다.
- 요약(summary): 응답의 크기와 대기 시간을 추적하는 데에 주로 사용하며, 측정한 이벤트의 합계와 카운트를 모두 제공한다.
- 히스토그램(histogram): 데이터가 단일 범주(category)에서 어떻게 분포되어 있는지와 시간 경과에 따른 추세를 나타낸다.

<details>
<summary>요약 vs 히스토그램</summary>

요약은 클라이언트 측에서 계산하고 분위수당 시계열을 생성하는 반면에 히스토그램는 서버에서 분위수를 계산하고 버킷당 시계열을 생성한다.

</details>

추가로, 기본적으로 제공해주는 메트릭이 부족할 경우에는 커스텀 메트릭을 개발해야 한다. 이를 위해서 계측 API와 SDK를 사용해서 커스텀 메트릭을 개발할 수 있지만, 운영자가 직접 커스텀 메트릭을 개발하는 것은 쉽지 않은 일이다. 

### 메트릭은 어떻게 관리해야 하는가?

- 메트릭의 이름을 지을 때는 정의된 표준을 지켜야 한다. 서비스 전체에 명명 규칙을 유지하는 것이 중요하다.
- 사용자 유형별로 올바른 백분율에 집중해야 한다. 어떤 서비스의 경우에는 요청의 95%가 0.1초 이하의 처리 시간이면 충분하지만, 다른 서비스는 요청의 99%가 0.1초 이하의 처리 시간을 요구한다.
- 상관관계를 가지는 차트를 대시보드에 구성하고, 도메인/서비스의 흐름대로 차트를 구성하는 것을 추천한다.
- 가능하면 태그를 사용해 메트릭에 상황 정보를 포함해야 한다. 메트릭에 태그를 달면 추후 그룹을 짓거나 더 많은 통찰을 얻는 데 도움이 된다.

# 3. 추적

### 추적이란 무엇인가?

**추적**(**tracing**)은 마이크로서비스가 시스템을 경유하며 트랜잭션을 처리하는 과정에서 발생하는 세부적인 정보를 문맥(context)과 로그, 태그 등의 메타데이터(metadata)를 통해 보여준다. 

추적과 APM은 유사점을 가지고 있지만 차이점 또한 분명히 존재한다. 바로 APM은 로그와 메트릭보다는 성능 관리에 집중하기 때문에 상관관계의 기능이 부족하다는 점이다. 따라서 APM이 가진 성능 관리의 기능과 관측 가능성이 추구하는 기능에는 분명한 차이가 존재하므로 이 둘을 비교하기보다는 관측 가능성을 보다 확장된 개념으로 이해하는 것이 바람직하다. 

<details>
<summary>참고</summary>

추적에 대한 자세한 내용은 6장에서 다룰 예정이다.

</details>

# 4. 로그

### 로그란 무엇인가?

**로그**(**log**)는 애플리케이션 실행 시 생성되는 텍스트 라인으로 구조적인 JSON 형식이나 비구조적인 텍스트 형식으로 출력된다. 로그는 애플리케이션 에러와 경고를 확인하고, 문제점에 대한 정확한 원인을 이해하기 위해 필요하다.  
로그 파일(엔트리)에 명시되어야 하는 중요한 정보에는 타임스탬프, 식별자, 소스, 레벨 또는 카테고리가 있다.

- 타임스탬프: 가능한 세밀하고 자세하게, 마이크로세컨드 및 GMT/UTC 시간대로 수집 권장
- 식별자: 가능한 많은 고유 식별자 ⇒ 여러 소스의 데이터를 상호 참조할 때 중요함
- 소스: 일반적으로 소스 데이터는 호스트, 클래스, 모듈, 함수 파일명 등임 ⇒ 디버깅에 도움 줌
- 레벨 또는 카테고리: 일반적으로 로그 레벨에는 ERROR, DEBUG, INFO, WARN의 값이 쓰임

### 로그는 어떻게 관리해야 하는가?

- 각 시스템에 분산되어 있는 로그를 **수집**하고 통합, 관리할 인프라를 먼저 구축해야 한다.   
- 각 애플리케이션은 다른 로그 형태를 가지고 있으므로, 로그의 형식을 **표준화**하고 단일화하는 것이 필요하다.  
- 구조적 로그는 JSON을 사용하는 것이 일반적이다. 하지만 레거시 시스템은 비구조적이고 단순한 텍스트 파일 형태로 구성되어 있다.   
- 오픈텔레메트리 로그 개발 시에는 구조화된 로그를 생성하는 것과 오픈텔레메트리와 연계하는 것이 중요하다.  

# 5. LGTM의 상관관계

### 상관관계의 필요성

데이터 분석가들은 ‘서로 다른 데이터가 정확하게 결합이 되었을 때 비로소 데이터의 활용 가치가 증가한다’라고 말한다. 즉, 로그, 메트릭, 추적, 트래픽 데이터는 서로 다른 이기종 데이터가 아니며, 아직 결합되지 않은 분리된 데이터일 뿐이라는 것이다. 따라서 관측 가능성의 활용도를 높이고 새로운 가치를 재발견하기 위해서는 데이터 간의 결합이 필요하다.  

<img width="300" alt="스크린샷 2024-09-15 오전 12 03 09" src="https://github.com/user-attachments/assets/8cb380cf-a889-4ac2-9189-8f35b3ae08cb">
<img width="300" alt="스크린샷 2024-09-15 오전 12 03 23" src="https://github.com/user-attachments/assets/60ffe1cc-6f39-4378-8eef-c8f2114c971f">

메트릭과 추적 이전부터 로그는 시스템을 이해하고 문제를 해결하기 위한 가장 기본적인 방법으로 손꼽혔다. 또한, **로그에 대한 통계와 집계 정보는 메트릭이 될 수 있으며, 로그를 발생 시점과 처리 시점을 계산해서 나열하면 추적이 될 수 있다**. 하지만 이 책에서는 상관관계에 대해 프로파일과 RUM을 추가하여 총 5가지 신호로 관측 가능성 상관관계를 구성하였다. 프로파일은 하위 수준의 상세한 디버깅 정보를 제공하며, Java와 Go 가상 머신의 CPU, 메모리 등에 대해서 분석할 수 있다. 그리고 RUM은 자바스크립트로 개발된 프론트엔드의 문제점을 분석하는 데 유용하다.

### 상관관계 구현 시 주의할 점

메트릭 데이터는 중요한 가용성 신호이며, 추적과 로그는 디버깅에 필수적인 데이터다. 둘 사이의 관계를 맺는 모든 작업은 결국 **가용성 저하 경고를 디버깅 정보로 전환하기 위한 사전 작업**인 셈이다. 대표적으로 시스템 담당자가 지연시간 상태 경고를 받으면 관측 가능성 대시보드에서 차트를 보고 해당 영역을 클릭해 즉시 분산 추적 시스템을 확인할 수 있다. 이렇게 메트릭과 추적의 가치는 이러한 연계 그래프를 통해 동반 상승한다. 이때, 추적 데이터는 비용을 제어하기 위해 샘플링을 거치는 경우가 많으므로 데이터 누락의 가능성이 있다. 따라서 메트릭과 추적 양쪽 모두에 서로 식별이 가능한, 일치하는 태그가 있는지 확인해야 한다.

# 6. 참고

[모니터링의 새로운 미래 관측 가능성 – Medium](https://yohaim.medium.com/)  
[모니터링의 새로운 미래 관측 가능성 - 예스24](https://m.yes24.com/Goods/Detail/123750696)


