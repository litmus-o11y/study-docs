# 1. 오픈텔레메트리란

### 오픈텔레메트리의 중요성

관측 가능성은 좋은 신호(텔레메트리)를 필요로 한다. 신호가 부정확하면 시스템을 이해하고 근본 원인을 분석하는 것도 부정확할 것이다. 관측 가능성뿐만 아니라 알람, 이상 탐지 예측(AIOps) 구현 시에도 신호가 가장 중요하다. 이때, **오픈텔레메트리**는 신호 개발의 표준이다. 추적을 위주로 시작한 오픈텔레메트리는 쿠버네티스 다음으로 가장 큰 CNCF(Cloud Native Computing Foundation) 커뮤니티로 떠올랐다. 

### 오픈텔레메트리의 역사

2019년 초에 2개의 기존 오픈소스 프로젝트인 오픈트레이싱(OpenTracing)과 오픈센서스(OpenCensus)가 오픈텔레메트리(OpenTelemetry) 프로젝트로 합병하였다. 프로젝트 초기에는 오픈센서스와 오픈트레이싱 커뮤니티 모두에게 핵심이었던 추적 기능을 통합하고, 기존 사용자들이 오픈텔레메트리로 쉽게 전환할 수 있도록 도움을 주는 데 집중했다. 이렇게 오픈텔레메트리는 애플리케이션의 계측(instrumenting) 방식과 텔레메트리 데이터가 생성, 수집, 전송되는 방식을 표준화하는 것을 목표로 한다.  
현재에는 데이터독, 뉴렐릭 등 관측 가능성 전문 솔루션 벤더와 구글, 아마존 등 메이저 클라우드 사업자 등이 참여하고 있으며, 매 분기마다 API SDK 컬렉터 등을 릴리즈하며 관측 가능성을 표준화하고 대중화하기 위해서 노력하고 있다. 현재는 추적 메트릭 로그를 아우르는 가장 큰 규모의 관측 가능성 프로젝트로 성장하여 텔레메트리에 관해서 표준으로 자리잡고 있으며, CNCF 내에서도 상당한 영향력을 미치고 있다.

# 2. 오픈텔레메트리 컴포넌트

### 오픈텔레메트리에서 정의하는 3가지

> 오픈텔레메트리는 신호(메트릭, 로그, 추적), 콘텍스트 전파, 파이프라인이라는 3가지 핵심 개념을 정의한다.

이 중에서 가장 중요한 것은 신호다. **신호**는 로그, 메트릭, 추적에 대한 기술적인 스펙을 정의하고, **파이프라인**은 오픈텔레메트리에서 컬렉터를 구현하는 구체적인 방법을 설명한다. **콘텍스트 전파**는 다양한 스트림(업, 다운 스트림) 간에 문맥을 전달하는 과정을 의미한다. 오픈텔레메트리는 분산된 마이크로서비스 간의 관계를 콘텍스트 전파로 표현한다.

<img width="178" alt="스크린샷 2024-09-15 오전 1 47 20" src="https://github.com/user-attachments/assets/13d02343-b03e-4fd0-a32c-4771812a8da1">

### 신호 구성 요소

1. 데이터 모델: 데이터 모델은 메트릭, 추적, 로그에 대한 상세한 레이아웃과 데이터 구조를 기술한다.
    <details>
    <summary>데이터 모델의 특징</summary>

    - 데이터 모델은 텔레메트리가 지원할 수 있는 OTLP(Opentelemetry Protocol)와 공급업체에 구애받지 않는 의미 체계 규칙(semantic convention)을 정의한다.
    - 데이터 모델은 표준을 구현하는 개발자에게 데이터가 어떻게 작동해야 하는지 알려준다.

    </details>

    <details>
    <summary>기존 데이터 모델과의 호환성</summary>

    프로메테우스 형식은 오픈텔레메트리 데이터 모델로 명확하게 변환할 수 있다. 추적은 기존의 다양한 추적 표준을 유지하는 것 보다는 새로운 오픈텔레메트리 추적으로 통합하는 방식을 사용하며, 로그는 다양한 언어별 로그 라이브러리를 사용할 수 있도록 유지하면서 텔레메트리의 로그를 보강하는 방향으로 개선하고 있다. 

    </details>

2. API(application programming interface): API는 공급업체에 의존성 없는 방식으로 계측하는 코드를 개발할 수 있으며, 사용자가 빠르게 시작하고 실행할 수 있도록 다양한 언어의 계측 라이브러리를 제공하고 있다.

    <details>
    <summary>API vs SDK</summary>

    API와 SDK의 차이점은 종속성으로 구분한다.  
    로직의 구현에만 집중하는 API는 종속적이지 않은 반면 SDK는 다양한 개발 언어, 벤더 솔루션, 신호를 지원함으로써 로직 외적인 벤더와 기술 종속적인 문제를 해결하였다.
    또한 API로 구현한 경우 텔레메트리 데이터는 실제로 텔레메트리 백엔드로 전달되지 않는다. 하지만, SDK는 백엔드로 내보내기를 지원한다.  

    </details>

3. SDK(software development kit): SDK는 오픈텔레메트리에서 텔레메트리를 생성, 집계, 전송하는 기본 시스템을 구현하며 텔레메트리의 수집 방법, 전송 위치, 구성 방법을 제공한다. 오픈텔레메트리 컬렉터가 오픈텔레메트리 SDK의 좋은 예이다. 또한 SDK는 API 호출을 내보낼 준비가 된 텔레메트리 데이터로 변환하는 데 필요한 핵심 기능을 구현한다. 즉, SDK는 내보내기 인터페이스를 정의한다. 

    <details>
    <summary>SDK가 활성화된 오픈텔레메트리 컴포넌트의 내부 구조</summary><br>

    <img width="303" alt="스크린샷 2024-09-15 오전 1 40 44" src="https://github.com/user-attachments/assets/9f0f0542-30be-44b9-a254-2cacf7d69fdb">

    </details>

4. 계측 라이브러리: 계측 라이브러리는 자동 계측과 동일한 의미라고 이해하면 된다. 즉, 파이썬의 플라스크와 장고, 자바의 스프링 부트 등 많이 사용하는 프레임워크를 지원하며, 직접적인 API 개발 없이 자동으로 계측이 가능하도록 돕는 것이 오픈텔레메트리 계측 라이브러리다. 

5. 리소스: 리소스는 텔레메트리를 생성하는 엔티티(entity)를 나타낸다. 오픈텔레메트리는 추적을 초기화하기 위해서 TracerProvider, 메트릭을 초기화하기 위해서 MeterProvider를 사용한다. 각 Provider 생성 시점에 리소스도 생성하며, Exporter에서 리소스를 참조한다. 이러한 방식을 통해서 SDK가 신호를 어디에서 받고, 어디로 보내야 하는지 이해할 수 있도록 도와준다.

6. 배기지: 배기지는 스팬 간에 전달되는 콘텍스트 정보를 나타낸다. 추적 콘텍스트 내에 있는 키-값 저장소로, 해당 추적 내에서 생성된 모든 스팬에서 값을 사용할 수 있다. 오픈텔레메트리는 콘텍스트 전파를 사용하여 배기지를 전달하며, 해당 배기지를 분석하고 사용할 수 있도록 만드는 전파자(propagator)를 통해 콘텍스트 전파를 구현할 수 있다.

    <details>
    <summary>배기지 API</summary>

    배기지는 텔레메트리에 주석을 달고 메트릭, 추적 및 로그에 콘텍스트와 정보를 추가하는 데 사용된다. 배기지의 각 이름은 정확히 하나의 값과 연결되어야 한다. API는 콘텍스트를 통해 배기지와 직접 상호작용하여 이러한 기능을 구현할 수 있다. 

    </details>

7. 이벤트: 이벤트는 스팬에서 사람이 읽을 수 있는 메시지이며, 필요 시에 언제든 추가할 수 있다. 로그와 유사한 개념이다.

8. 링크: 링크는 스팬 간 관계를 표현하는 것이다. 스팬은 다른 스팬에 연결하는 스팬 링크를 생성할 수 있다. 링크를 만들려면 스팬 콘텍스트가 필요하다.

### 콘텍스트 전파

마이크로서비스 사이에서는 상호 호출이 자주 발생하므로 추적에서 전파는 중요하다. 오픈텔레메트리에서도 그 중요성을 인식하고 콘텍스트 전파를 관측 가능성의 핵심 기능 중 하나로 선정했다.  
콘텍스트 전파는 분산 추적에서 여러 시스템의 요청을 함께 연관시키며, 이를 통해 배기지(사용자 정의값)를 전파할 수 있다. 뿐만 아니라 배기지를 사용하여 신호 전반에 걸쳐 텔레메트리에 주석을 달 수도 있다.

### 파이프라인

<img width="538" alt="스크린샷 2024-09-15 오전 3 28 47" src="https://github.com/user-attachments/assets/51bf0fc1-e39c-451d-98f6-1e4a010cfadf">

<br>

1. 프로바이더: 프로바이더는 텔레메트리 데이터를 생성하는 데 사용되는 엔티티다. 프로바이더는 텔레메트리 데이터를 생성하기 전 애플리케이션 코드 초기에 구성해야 한다. 
2. 텔레메트리 생성기: 텔레메트리 생성기는 신호에 따라 이름이 다르게 지정된다. 추적 신호는 텔레메트리 생성기를 트레이서라고 부르고, 메트릭 신호는 미터라고 부른다. 프로바이더가 텔레메트리 생성기를 인스턴스화할 때 애플리케이션과 계측 라이브러리는 프로바이더에게 이름을 전달해야 한다. 
3. 프로세서: 텔레메트리 데이터가 생성되면 프로세서는 데이터 내용을 추가로 수정할 수 있는 기능을 제공한다. 프로세서는 데이터를 처리해야 하는 빈도 또는 데이터를 내보내는 방법을 결정할 수 있다. 
4. 익스포터: 익스포터의 역할은 오픈텔레메트리의 내부 데이터 모델을 구성된 익스포터와 가장 일치하는 형식으로 변환하는 것이다.


# 3. 오픈텔레메트리 추적

### 오픈텔레메트리 추적이란

오픈텔레메트리가 설명하는 스팬은 작업(operation) 또는 작업 단위를 나타낸다. 다수의 스팬은 추적을 구성하며, 다음과 같은 데이터를 포함한다. 

- 부모 스팬 ID(parent span ID)
- 추적이 시작되고 끝난 시간(timestamps)
- 스팬 콘텍스트(context)
- 스팬 속성(attributes): 스팬은 연관된 속성을 설정할 수 있는 기능이 있으며, 속성은 키와 값으로 구성된다.

    <details>
    <summary>Go 코드</summary>

    <img width="526" alt="스크린샷 2024-09-15 오전 3 59 45" src="https://github.com/user-attachments/assets/8e0a2e7e-6f90-4206-a48d-e15565f7531e">

    </details>

- 스팬 이벤트(events): 스팬에는 이벤트를 추가할 수 있는 기능이 있으며, 이벤트에는 스팬이 추가되는 순간과 관련된 시간 정보가 있다. 이벤트는 기록되는 순서를 유지해야 한다. 

    <details>
    <summary>Go 코드</summary>

    <img width="527" alt="스크린샷 2024-09-15 오전 4 00 01" src="https://github.com/user-attachments/assets/c0205970-9fa4-45cb-a00f-5389f96b112e">

    </details>

    <details>
    <summary>이벤트 구성 요소</summary>

    - 이벤트의 이름
    - 이벤트가 추가된 시간 또는 사용자가 제공한 타임스탬프
    - 이벤트를 추가로 설명하는 0개 이상의 속성

    </details>

- 스팬 링크(link): 링크는 다른 스팬과의 관계를 정의하고, 스팬을 생성하는 동안 사용자는 다른 스팬에 대한 링크를 기록할 수 있다.

    <details>
    <summary>링크 구성 요소</summary>

    - 연결할 스팬의 스팬 콘텍스트
    - 링크를 추가로 설명하는 0개 이상의 속성

    </details>

- 스팬 상태(status)



### 오픈텔레메트리 추적 파이프라인
<img width="534" alt="스크린샷 2024-09-15 오전 4 16 06" src="https://github.com/user-attachments/assets/3523e277-e0b8-4778-8f9f-9bfe62c4a800">

내용 추가 중...